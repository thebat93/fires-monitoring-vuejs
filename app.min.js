"use strict";var _slicedToArray=function(){function e(e,t){var a=[],r=!0,s=!1,i=void 0;try{for(var n,l=e[Symbol.iterator]();!(r=(n=l.next()).done)&&(a.push(n.value),!t||a.length!==t);r=!0);}catch(e){s=!0,i=e}finally{try{!r&&l.return&&l.return()}finally{if(s)throw i}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();Vue.component("filter-panel",{template:"#filter-panel-component",props:{defaultFilters:{type:Object,required:!0},filtersData:{type:Object,required:!0}},data:function(){return{min:1,calendars:void 0,timePickers:void 0,showDate:!0,datePanel:"date",dateFilter:"",filters:{date:this.defaultFilters.date,satellite:this.defaultFilters.satellite,area:this.defaultFilters.area,source:this.defaultFilters.source,confidence_user:this.defaultFilters.confidence_user}}},computed:{isDisabled:function(){return void 0!==this.calendars&&this.calendars[0].config.maxDate.toString()==this.calendars[0].selectedDates[0].toString()}},methods:{openCalendar:function(e){this.calendars[e.target.dataset.calendar].toggle()},changeDay:function(e){var t=this.calendars[0].selectedDates[0],a="+"==e.target.textContent?new Date(t.getFullYear(),t.getMonth(),t.getDate()+1):new Date(t.getFullYear(),t.getMonth(),t.getDate()-1);this.calendars[0].setDate(a),this.updateDate()},updateFilter:function(){this.$emit("update",this.filters)},closePanel:function(){this.$emit("close")},updateDate:function(e){this.filters.date=[this.calendars[0].formatDate(this.calendars[0].selectedDates[0],"Y-m-d")+"T"+this.timePickers[0].formatDate(this.timePickers[0].selectedDates[0],"H:i:S")+".000Z",this.calendars[0].formatDate(this.calendars[0].selectedDates[0],"Y-m-d")+"T"+this.timePickers[1].formatDate(this.timePickers[1].selectedDates[0],"H:i:S")+".000Z"],this.updateFilter()},updateDates:function(e){this.filters.date=[this.calendars[1].formatDate(this.calendars[1].selectedDates[0],"Y-m-d")+"T"+this.timePickers[2].formatDate(this.timePickers[2].selectedDates[0],"H:i:S")+".000Z",this.calendars[2].formatDate(this.calendars[2].selectedDates[0],"Y-m-d")+"T"+this.timePickers[3].formatDate(this.timePickers[3].selectedDates[0],"H:i:S")+".000Z"],this.updateFilter()}},mounted:function(){L.DomEvent.disableClickPropagation(L.DomUtil.get("filterPanel")),L.DomEvent.disableScrollPropagation(L.DomUtil.get("filterPanel")),flatpickr.localize(flatpickr.l10ns.ru),this.calendars=flatpickr(".calendar",{maxDate:"today",defaultDate:"today"}),this.timePickers=flatpickr(".timepicker",{enableTime:!0,noCalendar:!0,time_24hr:!0,dateFormat:"H:i"})}});var app=new Vue({el:"#app",data:{map:void 0,openPanel:!1,url:"https://fire-rs.gazprom-spacesystems.ru/proxy_gazcom_rs/geoserver/GSS/wms",baseLayers:{Bing:new L.BingLayer("ApTJzdkyN1DdFKkRAE6QIDtzihNaf6IWJsT-nQ_2eMoO4PN__0Tzhl2-WgJtXFSp",{type:"Aerial"}),Yandex:L.tileLayer("http://vec{s}.maps.yandex.net/tiles?l=map&v=4.55.2&z={z}&x={x}&y={y}&scale=2&lang=ru_RU",{subdomains:["01","02","03","04"],attribution:'<a href="https://yandex.ru/" target="_blank">Яндекс</a>',reuseTiles:!0,updateWhenIdle:!1}),OpenStreetMap:L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'<a href="http://osm.org/copyright">OpenStreetMap</a>'})},overlays:{},groupedOverlays:{},userFilters:{date:[],confidence_user:[1,2],satellite:[0,1,2],area:[1,2,3,4],source:[0,1]},filterString:"",threatsFilterString:"",filtersData:{confidences:["Низкая","Средняя","Высокая"],satellites:["SuomiNPP","Aqua","Terra"],areas:["0 - 0.1","0.1 - 2","2 - 20","20 - 200","> 200"],sources:["GSS","EOSDIS"]}},methods:{updateFilter:function(e){var t=this,a=[];this.userFilters=e;for(var r in this.userFilters)!function(){switch(r){case"date":a.push("(date BETWEEN "+t.userFilters[r][0]+" AND "+t.userFilters[r][1]+")"),t.threatsFilterString="(date BETWEEN "+t.userFilters[r][0]+" AND "+t.userFilters[r][1]+")";break;case"area":var e=t.userFilters[r].sort(function(e,t){return e-t}),s=[];e.map(function(e){if(4===e)s.push("area > 200");else{var a=t.filtersData.areas[e].split(" - "),r=_slicedToArray(a,2),i=r[0],n=r[1];s.push("area BETWEEN "+i+" AND "+n)}}),a.push("("+s.join(" OR ")+")");break;case"confidence_user":a.push("(confidence_user IN ("+t.userFilters[r].map(function(e){return"'"+t.filtersData.confidences[e].toLowerCase()+"'"})+"))");break;case"satellite":a.push("(satellite IN ("+t.userFilters[r].map(function(e){return"'"+t.filtersData.satellites[e]+"'"})+"))");break;case"source":a.push("(source IN ("+t.userFilters[r].map(function(e){return"'"+t.filtersData.sources[e]+"'"})+"))")}}();this.filterString=a.join(" AND "),this.groupedOverlays["Пожары"]["Зоны пожаров (круп. масштаб)"].setParams({cql_filter:this.filterString}),this.groupedOverlays["Пожары"]["Зоны пожаров (мел. масштаб)"].setParams({cql_filter:this.filterString}),this.groupedOverlays["Пожары"]["Угрозы"].setParams({cql_filter:this.threatsFilterString})},getFeatureInfo:function(e){var t=this.getFeatureInfoUrl(e.latlng),a=L.Util.bind(this.showGetFeatureInfo,this);fetch(t).then(function(e){return e.text()}).then(function(t){a(e.latlng,t)}).catch(function(e){console.log(e)})},getFeatureInfoUrl:function(e){var t=this,a="",r="";this.map.eachLayer(function(e){e instanceof L.TileLayer.WMS&&!0===e.options.queryable&&(a+=e.wmsParams.layers+",","GSS:firepoint_poly_mini"===e.wmsParams.layers?r+=t.filterString+";":"GSS:threats_sql"===e.wmsParams.layers?r+=t.threatsFilterString+";":r+="INCLUDE;")}),r=r.slice(0,-1),a=a.slice(0,-1);var s=this.map.latLngToContainerPoint(e,this.map.getZoom()),i=this.map.getSize(),n={request:"GetFeatureInfo",service:"WMS",srs:"EPSG:4326",transparent:!0,version:"1.1.1",format:"image/png",bbox:this.map.getBounds().toBBoxString(),height:i.y,width:i.x,layers:a,query_layers:a,info_format:"text/html",feature_count:10,cql_filter:r};return n["1.3.0"===n.version?"i":"x"]=s.x,n["1.3.0"===n.version?"j":"y"]=s.y,this.url+L.Util.getParamString(n,this.url,!0)},showGetFeatureInfo:function(e,t){if(-1!=t.search("<ul>")){L.popup({maxWidth:800}).setLatLng(e).setContent(t).openOn(this.map)}}},created:function(){var e=this.url,t=new Date;t.setUTCHours(0,0,0,0);var a=new Date;a.setUTCHours(23,59,0,0),this.userFilters.date=[t.toISOString(),a.toISOString()],this.groupedOverlays={"Другие":{"Километраж газопровода":L.tileLayer.wms(e,{layers:"GSS:piki_km",transparent:!0,format:"image/png",queryable:!0}),"Зона мониторинга ГКС":L.tileLayer.wms(e,{layers:"GSS:zone_monitor",transparent:!0,format:"image/png",queryable:!0})},"Объекты":{"Газопровод":L.tileLayer.wms(e,{layers:"GSS:tube",transparent:!0,format:"image/png",queryable:!0}),"Газодобывающие комплексы":L.tileLayer.wms(e,{layers:"GSS:dobycha",transparent:!0,format:"image/png",queryable:!0}),"Факельные установки":L.tileLayer.wms(e,{layers:"GSS:fakel",transparent:!0,format:"image/png",queryable:!0}),"Эксплуатационные нарушения":L.tileLayer.wms(e,{layers:"GSS:violations",transparent:!0,format:"image/png",queryable:!1}),"Зоны ответственности":L.tileLayer.wms(e,{layers:"GSS:zone_notif",transparent:!0,format:"image/png",queryable:!0})},"Пожары":{"Зоны пожаров (круп. масштаб)":L.tileLayer.wms(e,{layers:"GSS:firepoint_poly",transparent:!0,format:"image/png",queryable:!1}),"Зоны пожаров (мел. масштаб)":L.tileLayer.wms(e,{layers:"GSS:firepoint_poly_mini",transparent:!0,format:"image/png",queryable:!0}),"Угрозы":L.tileLayer.wms(e,{layers:"GSS:threats_sql",transparent:!0,format:"image/png",queryable:!0})}},this.updateFilter(this.userFilters)},mounted:function(){var e=[this.baseLayers.Bing,this.groupedOverlays["Объекты"]["Газопровод"],this.groupedOverlays["Объекты"]["Газодобывающие комплексы"],this.groupedOverlays["Объекты"]["Факельные установки"],this.groupedOverlays["Объекты"]["Эксплуатационные нарушения"],this.groupedOverlays["Объекты"]["Зоны ответственности"],this.groupedOverlays["Пожары"]["Зоны пожаров (круп. масштаб)"],this.groupedOverlays["Пожары"]["Зоны пожаров (мел. масштаб)"],this.groupedOverlays["Пожары"]["Угрозы"]];this.map=L.map("map",{layers:e,center:[57,104],zoom:3,minZoom:3,maxBounds:L.latLngBounds(L.latLng(90,270),L.latLng(-90,-90))}),L.control.mousePosition().addTo(this.map),L.control.scale({imperial:!1}).addTo(this.map),L.control.ruler().addTo(this.map),L.control.groupedLayers(this.baseLayers,this.groupedOverlays,{groupCheckboxes:!0}).addTo(this.map);var t=document.querySelector(".leaflet-control-layers-list");L.DomEvent.disableClickPropagation(t),L.DomEvent.disableScrollPropagation(t),this.map.on("click",this.getFeatureInfo)}});